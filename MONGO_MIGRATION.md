# MongoDB Migration Guide

## Summary of Changes

Your College Event Portal has been successfully migrated from **PostgreSQL** to **MongoDB**. Below is a complete overview of all changes made.

---

## 1. Database Configuration

### Before (PostgreSQL)
```typescript
// lib/db.ts - Used pg Pool
import { Pool } from "pg"
```

### After (MongoDB)
```typescript
// lib/db.ts - Now uses Mongoose
import mongoose from "mongoose"

export async function connectDB() {
  // Automatically connects to MongoDB on first call
  await mongoose.connect(process.env.MONGO_URL)
}
```

**Action Required:**
- Update `.env` file:
  ```
  MONGO_URL=mongodb+srv://username:password@cluster.mongodb.net/college-event-portal
  ```

---

## 2. New Models File

Created **`lib/models.ts`** - Defines all MongoDB Schemas:

### Models Defined:
1. **User** - Students, Chairpersons, Admins
2. **Club** - Event organizing clubs
3. **Event** - College events
4. **Registration** - Event registrations with attendance & feedback
5. **EmailTemplate** - Email templates for notifications
6. **AuditLog** - System audit trails (auto-deletes after 1 year)

**Key Features:**
- Embedded documents (no complex joins needed)
- Automatic timestamps (`createdAt`, `updatedAt`)
- TTL indexes for automatic data cleanup
- Optimized indexing for fast queries

---

## 3. API Routes Updated

All 16 API endpoints have been migrated to MongoDB:

### Authentication Routes
| Route | Changes |
|-------|---------|
| `POST /api/auth/signup` | Uses User.create(), AuditLog.create() |
| `POST /api/auth/login` | Uses User.findOne(), AuditLog.create() |
| `GET /api/auth/me` | Uses User.findById() with select() |

### Events Routes
| Route | Changes |
|-------|---------|
| `GET /api/events` | MongoDB aggregation with $regex for search |
| `POST /api/events` | Creates Event with embedded location/schedule |
| `GET /api/events/[id]` | Populates club data, counts registrations |
| `PUT /api/events/[id]` | Uses findByIdAndUpdate() |
| `POST /api/events/[id]/register` | Creates Registration with user snapshot |
| `POST /api/events/[id]/register/confirm` | Populates event and sends email |

### Registration Routes
| Route | Changes |
|-------|---------|
| `GET /api/students/registrations` | Populates event data, sorts by date |
| `POST /api/students/registrations/[id]/cancel` | Updates status to "cancelled", decrements count |

### Chairperson Routes
| Route | Changes |
|-------|---------|
| `GET /api/chairperson/events` | Fetches events created by chairperson with stats |
| `GET /api/chairperson/events/[id]/registrations` | Lists registrations with user details |
| `GET /api/chairperson/analytics/[eventId]` | Calculates attendance stats from documents |
| `POST /api/chairperson/attendance/scan` | Marks attendance via QR code |
| `POST /api/chairperson/attendance/manual` | Manual attendance marking |

### Club Routes
| Route | Changes |
|-------|---------|
| `GET /api/clubs` | $regex search on name/description |
| `POST /api/clubs` | Creates new club (admin only) |

### User Profile Routes
| Route | Changes |
|-------|---------|
| `GET /api/users/profile` | Gets user profile |
| `PUT /api/users/profile` | Updates user profile |

---

## 4. Key Differences in Code

### Query Patterns

#### Finding Users
```typescript
// Old (PostgreSQL)
const result = await pool.query("SELECT * FROM users WHERE email = $1", [email])
const user = result.rows[0]

// New (MongoDB)
const user = await User.findOne({ email: email.toLowerCase() })
```

#### Creating Records
```typescript
// Old (PostgreSQL)
const result = await pool.query(
  "INSERT INTO users (...) VALUES (...) RETURNING *",
  [...]
)
const user = result.rows[0]

// New (MongoDB)
const user = await User.create({
  email, passwordHash, fullName, ...
})
```

#### Updating Records
```typescript
// Old (PostgreSQL)
await pool.query("UPDATE events SET title = $1 WHERE id = $2", [title, id])

// New (MongoDB)
await Event.findByIdAndUpdate(id, { $set: { title } }, { new: true })
```

#### Counting
```typescript
// Old (PostgreSQL)
const result = await pool.query("SELECT COUNT(*) as count FROM registrations WHERE ...")
const count = result.rows[0].count

// New (MongoDB)
const count = await Registration.countDocuments({ ... })
```

#### Populating Relations
```typescript
// Old (PostgreSQL) - Required manual JOINs
const result = await pool.query(`
  SELECT e.*, c.name as club_name
  FROM events e
  JOIN clubs c ON e.club_id = c.id
`)

// New (MongoDB) - Automatic population
const events = await Event.find()
  .populate("clubId", "name assets")
  .lean()
```

---

## 5. Data Type Mappings

| PostgreSQL | MongoDB | Notes |
|-----------|---------|-------|
| `SERIAL` | `ObjectId` | Auto-generated by Mongoose |
| `VARCHAR` | `String` | Same behavior |
| `INTEGER` | `Number` | Same behavior |
| `BOOLEAN` | `Boolean` | Same behavior |
| `TIMESTAMP` | `Date` | JavaScript Date objects |
| `TEXT` | `String` | Same behavior |
| `JSON` | `Map<String, Mixed>` | Flexible storage |
| `DECIMAL(10,2)` | `Number` | Stored as float |

---

## 6. Connection Lifecycle

### Before (PostgreSQL)
```typescript
const pool = new Pool(config)
// Manual connection pooling
```

### After (MongoDB)
```typescript
// In each API route:
await connectDB()

// Or use automatic connection
import { connectDB } from "@/lib/db"
```

**Note:** The connection is cached in development to prevent multiple connections.

---

## 7. Environment Variables

### Required `.env` file:
```bash
# MongoDB
MONGO_URL=mongodb+srv://username:password@cluster.mongodb.net/college-event-portal?retryWrites=true

# JWT
JWT_SECRET=your-secret-key-here

# Brevo Email
BREVO_API_KEY=your-brevo-key

# Other configs
NODE_ENV=development
```

---

## 8. Removed SQL Features

### No Longer Available:
- ❌ SQL transactions (use MongoDB transactions if needed)
- ❌ Complex JOIN queries (use population instead)
- ❌ SQL triggers (implement in application logic)
- ❌ Stored procedures (use utility functions)

### Handled Differently:
- ✅ Audit logging - Using embedded documents in Registration
- ✅ Attendance tracking - Embedded logs array in each registration
- ✅ User club memberships - Embedded clubMemberships array

---

## 9. Performance Considerations

### Indexes Created
```javascript
// User
- email (unique)
- rollNumber

// Event
- clubId
- isPublished
- schedule.startDate

// Registration
- eventId, userId (unique compound)
- userId
- eventId
- status

// AuditLog
- userId
- TTL (auto-delete after 1 year)
```

### Query Optimization Tips
1. Use `.lean()` for read-only queries (faster)
2. Use `.select()` to limit fields returned
3. Use `.sort()` before `.limit()` for efficiency
4. Consider denormalization for frequently read data

---

## 10. Testing Checklist

- [ ] Environment variables set correctly
- [ ] MongoDB connection works
- [ ] User signup/login flow
- [ ] Event creation and listing
- [ ] Event registration
- [ ] Attendance marking
- [ ] Analytics calculation
- [ ] Email confirmations send
- [ ] Role-based access control
- [ ] Audit logs are recorded

---

## 11. Common Issues & Solutions

### Issue: Connection Timeout
```bash
# Solution: Check MongoDB connection string
# Ensure IP is whitelisted in MongoDB Atlas
```

### Issue: ObjectId Type Errors
```typescript
// Solution: Always wrap IDs in Types.ObjectId()
new Types.ObjectId(payload.userId)
```

### Issue: Undefined Properties
```typescript
// Solution: Use .lean() and ensure population
const user = await User.findById(id).lean()
```

---

## 12. Next Steps

1. ✅ **Database Connection** - Configure MongoDB credentials
2. ✅ **Run API Tests** - Verify all endpoints work
3. ✅ **Load Testing** - Test with realistic data volume
4. ✅ **Backup Strategy** - Set up MongoDB backups
5. ✅ **Monitoring** - Set up error tracking
6. ✅ **Documentation** - Update team docs

---

## 13. Rollback Plan

If you need to roll back to PostgreSQL:
1. Keep the old `lib/db.ts` (Pool version) in version control
2. Keep SQL API implementations
3. Switch back by reverting these files
4. Restore from PostgreSQL backup

**Recommendation:** Keep both versions for 1-2 weeks before deleting SQL code.

---

## Support

For MongoDB-specific questions:
- [Mongoose Documentation](https://mongoosejs.com)
- [MongoDB Manual](https://docs.mongodb.com/manual/)
- [MongoDB Atlas Guide](https://docs.atlas.mongodb.com/)
